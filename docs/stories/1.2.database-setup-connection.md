# Story 1.2: Database Setup and Connection

## Status
Approved

## Story
**As a** developer,
**I want** to set up a PostgreSQL database and connect it to the Next.js application using Prisma,
**so that** the application has a persistent data layer for user management and image storage.

## Acceptance Criteria
1. PostgreSQL database is set up and accessible
2. Prisma schema is implemented with User and Image models
3. Database connection is established from the Next.js application
4. Database migrations can be run successfully
5. Basic database operations (CRUD) can be performed
6. Environment configuration is properly set up

## Tasks / Subtasks
- [ ] Set up PostgreSQL database (AC: 1)
  - [ ] Install PostgreSQL 16.3 locally for development
  - [ ] Create development database
  - [ ] Verify database connection
- [x] Implement Prisma schema (AC: 2)
  - [x] Add User model with Role enum to schema.prisma
  - [x] Add Image model with user relationship to schema.prisma
  - [x] Configure proper indexes and constraints
  - [x] Set up proper field types and validation
- [ ] Establish database connection (AC: 3)
  - [ ] Configure DATABASE_URL environment variable
  - [ ] Set up Prisma client in packages/db/index.ts
  - [ ] Export Prisma client for use in Next.js app
  - [ ] Test connection from Next.js application
- [ ] Set up database migrations (AC: 4)
  - [ ] Initialize Prisma migrations
  - [ ] Generate initial migration from schema
  - [ ] Apply migration to development database
  - [ ] Verify tables are created correctly
- [ ] Implement basic CRUD operations (AC: 5)
  - [ ] Create database utility functions for User operations
  - [ ] Create database utility functions for Image operations
  - [ ] Test create, read, update, delete operations
- [ ] Configure environment setup (AC: 6)
  - [ ] Update .env.example with database configuration
  - [ ] Document required environment variables
  - [ ] Set up development environment variables

## Dev Notes

### Previous Story Insights
From Story 1.1 [Source: docs/stories/1.1.project-initialization.md]:
- T3 Stack monorepo structure is already established
- Prisma package foundation is created in packages/db/
- Basic Prisma configuration is in place
- Development environment is ready and verified

### Data Models
Based on Database Schema [Source: architecture/07-section-7-database-schema.md]:
- **User Model**: id (VARCHAR(255)), email (VARCHAR(255) UNIQUE), password (VARCHAR(255)), role (Role enum), created_at (TIMESTAMP), updated_at (TIMESTAMP)
- **Image Model**: id (VARCHAR(255)), url (TEXT), user_id (VARCHAR(255) FK), created_at (TIMESTAMP)
- **Role Enum**: CLIENT, ADMIN
- **Relationships**: User has many Images (one-to-many), Image belongs to User (many-to-one)
- **Indexes**: Image_user_id_idx on Image(user_id)

### API Specifications
No specific API endpoints required for this story - this is database layer setup only.

### Component Specifications
No specific UI components required for this story - this is database layer setup only.

### File Locations
Based on Project Structure [Source: architecture/09-section-9-unified-project-structure.md]:
- Prisma schema: `packages/db/schema.prisma`
- Database package exports: `packages/db/index.ts`
- Database package configuration: `packages/db/package.json`
- Environment configuration: `apps/nextjs/.env.local` (development)
- Environment example: `apps/nextjs/.env.example`

### Testing Requirements
Based on Testing Strategy [Source: architecture/13-section-13-testing-strategy.md]:
- Use Vitest for unit and integration testing
- Follow testing pyramid approach
- Test files should be co-located with database functions
- Testing framework: Vitest 1.5.0
- Test database connection, schema validation, and CRUD operations

### Technical Constraints
Based on Tech Stack [Source: architecture/03-section-3-tech-stack.md]:
- PostgreSQL version: 16.3
- Prisma version: 5.12.1
- Database provider: postgresql
- Environment: Development database setup required
- Must support the defined User and Image models with proper relationships

### Project Structure Notes
The database package is already established in packages/db/ with basic Prisma configuration. This story will expand the existing foundation to include the complete data models and connection setup.

## Testing
- Test file location: `packages/db/__tests__/` (co-located with database functions)
- Test standards: Follow testing pyramid using Vitest
- Testing frameworks: Vitest 1.5.0 for unit/integration tests
- Specific testing requirements: Test database connection, schema validation, CRUD operations, and migration processes

## Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| Aug 14, 2025 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
James (Full Stack Developer)

### Debug Log References
- Added `Image` model with relation to `User` and index `Image_user_id_idx`
- Updated `packages/db/schema.prisma` and validated schema structure

### Completion Notes List
- Prisma schema extended to include `Image` with one-to-many to `User`
- Acceptance Criteria 2 satisfied

### File List
- `packages/db/schema.prisma` (edited)
- `apps/nextjs/env.example` (edited)

## QA Results
*This section will be populated by the QA agent during review*
